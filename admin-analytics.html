<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics y Monitoreo | AnalisisEC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .metric-card {
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="admin.html" class="flex items-center space-x-2">
                        <i class="fas fa-chart-bar text-2xl text-indigo-600"></i>
                        <span class="font-bold text-xl text-gray-900">Analytics</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="admin.html" class="text-gray-700 hover:text-indigo-600 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Volver al Admin
                    </a>
                    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Métricas principales -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="metric-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-3 rounded-lg">
                        <i class="fas fa-users text-2xl text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Visitas Hoy</p>
                        <p id="todayVisits" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>

            <div class="metric-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center">
                    <div class="bg-green-100 p-3 rounded-lg">
                        <i class="fas fa-file-pdf text-2xl text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Archivos Procesados</p>
                        <p id="filesProcessed" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>

            <div class="metric-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center">
                    <div class="bg-yellow-100 p-3 rounded-lg">
                        <i class="fas fa-clock text-2xl text-yellow-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Tiempo Promedio</p>
                        <p id="avgProcessingTime" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>

            <div class="metric-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center">
                    <div class="bg-red-100 p-3 rounded-lg">
                        <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Errores Hoy</p>
                        <p id="todayErrors" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Gráfico de visitas -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-chart-line mr-2 text-blue-600"></i>Visitas Últimos 7 Días
                </h3>
                <canvas id="visitsChart" width="400" height="200"></canvas>
            </div>

            <!-- Gráfico de errores -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-exclamation-circle mr-2 text-red-600"></i>Errores por Tipo
                </h3>
                <canvas id="errorsChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Tabla de errores recientes -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-bug mr-2 text-red-600"></i>Errores Recientes
                </h3>
                <button id="refreshBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>Actualizar
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tiempo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mensaje</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">URL</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="errorsTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Cargando errores...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Eventos en tiempo real -->
        <div class="bg-white rounded-xl shadow-lg p-6 mt-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-stream mr-2 text-green-600"></i>Eventos en Tiempo Real
            </h3>
            <div id="realTimeEvents" class="max-h-64 overflow-y-auto space-y-2">
                <p class="text-gray-500 text-center">Esperando eventos...</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="src/services/AdminAuth.js"></script>
    <script src="src/utils/Analytics.js"></script>

    <script>
        class AdminAnalytics {
            constructor() {
                this.supabase = null;
                this.charts = {};
                this.realTimeSubscription = null;
                this.init();
            }

            async init() {
                // Verificar autenticación
                const auth = window.AdminAuth;
                await auth.init();

                if (!auth.isAuthenticated()) {
                    window.location.href = 'admin-login.html';
                    return;
                }

                // Inicializar Supabase
                this.supabase = window.supabase.createClient(
                    CONFIG.supabase.url,
                    CONFIG.supabase.anonKey
                );

                // Configurar eventos
                this.setupEventListeners();

                // Cargar datos
                await this.loadMetrics();
                await this.loadCharts();
                await this.loadRecentErrors();

                // Configurar actualización automática
                this.setupAutoRefresh();

                // Configurar eventos en tiempo real
                this.setupRealTimeEvents();
            }

            setupEventListeners() {
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.refreshAllData();
                });

                document.getElementById('logoutBtn').addEventListener('click', async () => {
                    await window.AdminAuth.logout();
                    window.location.href = 'admin-login.html';
                });
            }

            async loadMetrics() {
                try {
                    const today = new Date().toISOString().split('T')[0];

                    // Métricas de hoy
                    const { data: todayMetrics } = await this.supabase
                        .from('usage_metrics')
                        .select('*')
                        .eq('date', today)
                        .single();

                    if (todayMetrics) {
                        document.getElementById('todayVisits').textContent = todayMetrics.total_visits || 0;
                        document.getElementById('filesProcessed').textContent = todayMetrics.files_processed || 0;
                        document.getElementById('avgProcessingTime').textContent =
                            todayMetrics.avg_processing_time_ms ? `${todayMetrics.avg_processing_time_ms}ms` : '0ms';
                        document.getElementById('todayErrors').textContent = todayMetrics.errors_count || 0;
                    } else {
                        // Si no hay datos de hoy, mostrar 0
                        document.getElementById('todayVisits').textContent = '0';
                        document.getElementById('filesProcessed').textContent = '0';
                        document.getElementById('avgProcessingTime').textContent = '0ms';
                        document.getElementById('todayErrors').textContent = '0';
                    }

                } catch (error) {
                    console.error('Error cargando métricas:', error);
                }
            }

            async loadCharts() {
                try {
                    // Datos de los últimos 7 días
                    const { data: weeklyData } = await this.supabase
                        .from('usage_metrics')
                        .select('date, total_visits, errors_count')
                        .gte('date', new Date(Date.now() - 7*24*60*60*1000).toISOString().split('T')[0])
                        .order('date', { ascending: true });

                    // Gráfico de visitas
                    this.createVisitsChart(weeklyData || []);

                    // Datos de errores por tipo
                    const { data: errorTypes } = await this.supabase
                        .from('error_logs')
                        .select('error_type')
                        .gte('timestamp', new Date(Date.now() - 7*24*60*60*1000).toISOString());

                    this.createErrorsChart(errorTypes || []);

                } catch (error) {
                    console.error('Error cargando gráficos:', error);
                }
            }

            createVisitsChart(data) {
                const ctx = document.getElementById('visitsChart').getContext('2d');

                this.charts.visits = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => new Date(d.date).toLocaleDateString()),
                        datasets: [{
                            label: 'Visitas',
                            data: data.map(d => d.total_visits),
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            createErrorsChart(errorData) {
                const errorCounts = {};
                errorData.forEach(error => {
                    errorCounts[error.error_type] = (errorCounts[error.error_type] || 0) + 1;
                });

                const ctx = document.getElementById('errorsChart').getContext('2d');

                this.charts.errors = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(errorCounts),
                        datasets: [{
                            data: Object.values(errorCounts),
                            backgroundColor: [
                                '#EF4444',
                                '#F59E0B',
                                '#8B5CF6',
                                '#10B981',
                                '#3B82F6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            }

            async loadRecentErrors() {
                try {
                    const { data: errors } = await this.supabase
                        .from('error_logs')
                        .select('*')
                        .order('timestamp', { ascending: false })
                        .limit(20);

                    this.displayErrorsTable(errors || []);

                } catch (error) {
                    console.error('Error cargando errores:', error);
                }
            }

            displayErrorsTable(errors) {
                const tbody = document.getElementById('errorsTableBody');

                if (errors.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                <i class="fas fa-check-circle mr-2 text-green-500"></i>No hay errores recientes
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = errors.map(error => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${new Date(error.timestamp).toLocaleString()}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                ${error.error_type}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">
                            ${error.error_data?.message || 'Sin mensaje'}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">
                            ${error.url || 'N/A'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${error.resolved ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${error.resolved ? 'Resuelto' : 'Pendiente'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            }

            setupRealTimeEvents() {
                const eventsContainer = document.getElementById('realTimeEvents');

                // Suscribirse a nuevos eventos
                this.realTimeSubscription = this.supabase
                    .channel('analytics_events')
                    .on('postgres_changes',
                        { event: 'INSERT', schema: 'public', table: 'analytics_events' },
                        (payload) => {
                            this.addRealTimeEvent(payload.new, eventsContainer);
                        }
                    )
                    .on('postgres_changes',
                        { event: 'INSERT', schema: 'public', table: 'error_logs' },
                        (payload) => {
                            this.addRealTimeError(payload.new, eventsContainer);
                        }
                    )
                    .subscribe();
            }

            addRealTimeEvent(event, container) {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'flex items-center p-3 bg-green-50 border border-green-200 rounded-lg';
                eventDiv.innerHTML = `
                    <i class="fas fa-circle text-green-500 mr-3"></i>
                    <div class="flex-1">
                        <span class="font-medium text-green-800">${event.event_name}</span>
                        <span class="text-green-600 text-sm ml-2">${new Date(event.timestamp).toLocaleTimeString()}</span>
                    </div>
                `;

                container.prepend(eventDiv);

                // Mantener solo los últimos 10 eventos
                const events = container.children;
                if (events.length > 10) {
                    container.removeChild(events[events.length - 1]);
                }
            }

            addRealTimeError(error, container) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'flex items-center p-3 bg-red-50 border border-red-200 rounded-lg';
                errorDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                    <div class="flex-1">
                        <span class="font-medium text-red-800">${error.error_type}</span>
                        <span class="text-red-600 text-sm ml-2">${new Date(error.timestamp).toLocaleTimeString()}</span>
                    </div>
                `;

                container.prepend(errorDiv);

                // Mantener solo los últimos 10 eventos
                const events = container.children;
                if (events.length > 10) {
                    container.removeChild(events[events.length - 1]);
                }
            }

            setupAutoRefresh() {
                // Actualizar métricas cada 30 segundos
                setInterval(() => {
                    this.loadMetrics();
                }, 30000);

                // Actualizar errores cada minuto
                setInterval(() => {
                    this.loadRecentErrors();
                }, 60000);
            }

            async refreshAllData() {
                const refreshBtn = document.getElementById('refreshBtn');
                const originalText = refreshBtn.innerHTML;

                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Actualizando...';
                refreshBtn.disabled = true;

                try {
                    await Promise.all([
                        this.loadMetrics(),
                        this.loadCharts(),
                        this.loadRecentErrors()
                    ]);
                } catch (error) {
                    console.error('Error actualizando datos:', error);
                } finally {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                }
            }
        }

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            new AdminAnalytics();
        });
    </script>
</body>
</html>